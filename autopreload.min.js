/*
 * autopreload.js v0.3
 *
 *
 * Purpose of this utility is to automatically preload images 
 * from css stylesheets in order to avoid unpleasant flicker effect.
 *
 * Krystian Jarmicki, 2013; Licensed MIT
 * @preserve
 */
(function(e){"use strict";var t=function(e,t){var s;for(s=0;e.length>s;s++)if(e[s]===t)return s;return-1},s=function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),s=e.shift();return function(){return t.apply(s,arguments)}};e.autopreload=function(e){var i={_states:[":hover",":active",":focus",":checked"],_sources:[],_images:[],_loaded:0,_userDefined:{modify:function(e,s,i){var r;if("[object Array]"===Object.prototype.toString.call(i))for(r=0;i.length>r;r++)this.modify(e,s,i[r]);else-1===t(this[e][s],i)&&this[e][s].push(i)},is:function(e,t,s){var i;for(i=0;this[e][t].length>i;i++)if(this[e][t][i]===s)return!0;return!1},images:{add:[],ignore:[]},files:{ignore:[]}},_onload:null,_getFileDir:function(e){var t=e.split("").reverse().join("");return t.indexOf("/")>-1?t.substr(t.indexOf("/")).split("").reverse().join(""):e},_getFullPathSource:function(e,t){var s;return e=e.replace(/\"/g,"").replace("url(","").replace(")",""),0!==e.indexOf(t)&&("/"===e[0]?e=this._getFileDomain(t)+e:(s=e.match(/^(?:http(s?)\:\/\/)?/g),(!s||1===s.length&&!s[0])&&(e=t+e))),e},_getFileName:function(e){return e=e.replace(/\"/g,"").replace("url(","").replace(")",""),0!==e.indexOf("data:")&&e.indexOf("/")>-1&&(e=e.split("").reverse().join(""),e=e.substr(0,e.indexOf("/")).split("").reverse().join("")),e},_getFileDomain:function(e){var t=e.match(/^(?:http(s?)\:\/\/)?/g)[0];return e=e.replace(t,""),e=e.substr(0,e.indexOf("/")),t+e},_walkSubtree:function(e,t){var s;if(e.cssRules||e.rules)this._walkSubtree(e.cssRules||e.rules,t);else if(e.length)for(s=0;e.length>s;s++)this._walkSubtree(e[s],t);else e.selectorText&&this._extractUrls(e,t)},_extractUrls:function(e,t){var s,i,r=!1,n=!1;for(s=0;this._states.length>s;s++)e.selectorText.indexOf(this._states[s])>-1&&(n=!0);if(!n&&this._userDefined.images.add.length>0&&(n=!0,r=!0),n)if("function"==typeof e.style.getPropertyValue)i=e.style.getPropertyValue("background-image"),i&&this._tryPush(i,t,r);else for(i in e.style)e.style[i]&&"string"==typeof e.style[i]&&0===e.style[i].indexOf("url(")&&e.style[i].indexOf(")")===e.style[i].length-1&&this._tryPush(e.style[i],t,r)},_tryPush:function(e,s,i){var r=this._getFullPathSource(e,s),n=this._getFileName(e);-1!==t(this._sources,r)||this._userDefined.is("images","ignore",n)||0===n.indexOf("data:")||(i?!this._userDefined.is("images","add",n):0)||this._sources.push(r)},_getSources:function(){var t;for(this._sources.length=0,t=0;e.document.styleSheets.length>t;t++)this._userDefined.is("files","ignore",this._getFileName(e.document.styleSheets[t].href))||this._walkSubtree(e.document.styleSheets[t],this._getFileDir(e.document.styleSheets[t].href));return this._sources},_createImages:function(){var t,s=this;for(this._images=[],this._loaded=0,t=0;this._sources.length>t;t++)this._images[t]=e.document.createElement("img"),this._images[t].onload=this._images[t].onerror=function(){++s._loaded===s._sources.length&&"function"==typeof s._onload&&s._onload.call(s,s._images)},this._images[t].src=this._sources[t];return this._images},addImages:function(e){return this._userDefined.modify("images","add",e),this},ignoreImages:function(e){return this._userDefined.modify("images","ignore",e),this},ignoreFiles:function(e){return this._userDefined.modify("files","ignore",e),this},run:function(){return this._getSources(),this._createImages()},onload:function(e){return"function"==typeof e&&(this._onload=e),this},reset:function(){var e;for(this._userDefined.images.add.length=this._userDefined.images.ignore.length=this._userDefined.files.ignore.length=this._sources.length=this._loaded=0,e=0;this._images.length>e;e++)this._images[e].onload=null;return this._images=[],this._onload=null,this}};return{run:s(i.run,i),addImages:s(i.addImages,i),ignoreImages:s(i.ignoreImages,i),ignoreFiles:s(i.ignoreFiles,i),onload:s(i.onload,i),reset:s(i.reset,i)}}(e)})(this);