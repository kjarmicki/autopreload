/*
 * autopreload.js v0.2
 *
 *
 * Purpose of this utility is to automatically preload images 
 * from css stylesheets in order to avoid unpleasant flicker effect.
 *
 * Krystian Jarmicki, 2013; Licensed MIT
 * @preserve
 */
(function(e){"use strict";e.autopreload=function(e){var t={_states:[":hover",":active",":focus",":checked"],_sources:[],_images:[],_loaded:0,_userDefined:{modify:function(e,t,s){var i;if("[object Array]"===Object.prototype.toString.call(s))for(i=0;s.length>i;i++)this.modify(e,t,s[i]);else-1===this[e][t].indexOf(s)&&this[e][t].push(s)},is:function(e,t,s){var i;for(i=0;this[e][t].length>i;i++)if(this[e][t][i]===s)return!0;return!1},images:{add:[],ignore:[]},files:{ignore:[]}},_onload:null,_getFileDir:function(e){var t=e.split("").reverse().join("");return t.indexOf("/")>-1?t.substr(t.indexOf("/")).split("").reverse().join(""):e},_getFullPathSource:function(e,t){var s;return e=e.replace(/\"/g,"").replace("url(","").replace(")",""),0!==e.indexOf(t)&&("/"===e[0]?e=this._getFileDomain(t)+e:(s=e.match(/^(?:http(s?)\:\/\/)?/g),(!s||1===s.length&&!s[0])&&(e=t+e))),e},_getFileName:function(e){return e=e.replace(/\"/g,"").replace("url(","").replace(")",""),0!==e.indexOf("data:")&&e.indexOf("/")>-1&&(e=e.split("").reverse().join(""),e=e.substr(0,e.indexOf("/")).split("").reverse().join("")),e},_getFileDomain:function(e){var t=e.match(/^(?:http(s?)\:\/\/)?/g)[0];return e=e.replace(t,""),e=e.substr(0,e.indexOf("/")),t+e},_walkSubtree:function(e,t){var s;if(e.cssRules||e.rules)this._walkSubtree(e.cssRules||e.rules,t);else if(e.length)for(s=0;e.length>s;s++)this._walkSubtree(e[s],t);else e.selectorText&&this._extractUrls(e,t)},_extractUrls:function(e,t){var s,i,r,n,o=!1,a=!1;for(s=0;this._states.length>s;s++)e.selectorText.indexOf(this._states[s])>-1&&(a=!0);if(!a&&this._userDefined.images.add.length>0&&(a=!0,o=!0),a)if("function"==typeof e.style.getPropertyValue)i=e.style.getPropertyValue("background-image"),i&&(r=this._getFullPathSource(i,t),n=this._getFileName(i),-1!==this._sources.indexOf(r)||this._userDefined.is("images","ignore",n)||0===n.indexOf("data:")||(o?!this._userDefined.is("images","add",n):0)||this._sources.push(r));else for(i in e.style)e.style[i]&&"string"==typeof e.style[i]&&0===e.style[i].indexOf("url(")&&e.style[i].indexOf(")")===e.style[i].length-1&&(r=this._getFullPathSource(e.style[i],t),n=this._getFileName(e.style[i]),-1!==this._sources.indexOf(r)||this._userDefined.is("images","ignore",n)||0===n.indexOf("data:")||(o?!this._userDefined.is("images","add",n):0)||this._sources.push(r))},_getSources:function(){var t;for(this._sources.length=0,t=0;e.document.styleSheets.length>t;t++)this._userDefined.is("files","ignore",this._getFileName(e.document.styleSheets[t].href))||this._walkSubtree(e.document.styleSheets[t],this._getFileDir(e.document.styleSheets[t].href));return this._sources},_createImages:function(){var t,s=this;for(this._images=[],this._loaded=0,t=0;this._sources.length>t;t++)this._images[t]=e.document.createElement("img"),this._images[t].onload=this._images[t].onerror=function(){++s._loaded===s._sources.length&&"function"==typeof s._onload&&s._onload.call(s,s._images)},this._images[t].src=this._sources[t];return this._images},addImages:function(e){return this._userDefined.modify("images","add",e),this},ignoreImages:function(e){return this._userDefined.modify("images","ignore",e),this},ignoreFiles:function(e){return this._userDefined.modify("files","ignore",e),this},run:function(){return this._getSources(),this._createImages()},onload:function(e){return"function"==typeof e&&(this._onload=e),this},reset:function(){var e;for(this._userDefined.images.add.length=this._userDefined.images.ignore.length=this._userDefined.files.ignore.length=this._sources.length=this._loaded=0,e=0;this._images.length>e;e++)this._images[e].onload=function(){};return this._images=[],this._onload=null,this}};Array.prototype.indexOf||function(e){var t,s=[e._userDefined.images.add,e._userDefined.images.ignore,e._userDefined.files.ignore,e._sources];for(t=0;s.length>t;t++)s[t].indexOf=function(e){var t;for(t=0;this.length>t;t++)if(this[t]===e)return e;return-1}}(t);var s=function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),s=e.shift();return function(){return t.apply(s,arguments)}};return{run:s(t.run,t),addImages:s(t.addImages,t),ignoreImages:s(t.ignoreImages,t),ignoreFiles:s(t.ignoreFiles,t),onload:s(t.onload,t),reset:s(t.reset,t)}}(e)})(this);